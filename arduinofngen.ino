#include <LiquidCrystal.h>

#ifndef ASYNC_ANALOG_H
#define ASYNC_ANALOG_H

uint16_t *async_analog_dest = 0;

#define async_analog_ready() (!async_analog_dest)

#define async_analog_check()                                            \
  do                                                                    \
  {                                                                     \
    if (!bit_is_set(ADCSRA, ADSC) && async_analog_dest)                 \
    {                                                                   \
      uint8_t low, high;                                                \
      low  = ADCL;                                                      \
      high = ADCH;                                                      \
      *async_analog_dest = high << 8 | low;                             \
      async_analog_dest = 0;                                            \
    }                                                                   \
  } while (0)

#define async_analog_read(pin, into)                                    \
  do                                                                    \
  {                                                                     \
    if (async_analog_ready())                                           \
    {                                                                   \
      async_analog_dest = (into);                                       \
      ADMUX   = DEFAULT << 6 | (pin) & 7;                               \
      ADCSRB  = ((pin) >> 3 & 1) << MUX5;                               \
      ADCSRA |= 1 << ADSC;                                              \
    }                                                                   \
  } while (0)

class AnalogMonitor
{
 private:
  uint8_t  pin;
  uint8_t  last_value;
  uint16_t value;

 public:
  AnalogMonitor(uint8_t _pin): pin(_pin), last_value(0), value(0) {}

  bool has_changed()
  {
    async_analog_check();
    bool result = value >> 2 != last_value;
    last_value  = value >> 2;
    return result;
  }

  void update()
  {
    async_analog_check();
    async_analog_read(pin, &value);
  }

  uint16_t val()
  {
    async_analog_check();
    return value;
  }
};

#define LCD_POT 6

AnalogMonitor pots[] = { AnalogMonitor(9),
                         AnalogMonitor(10),
                         AnalogMonitor(11),
                         AnalogMonitor(12),
                         AnalogMonitor(13),
                         AnalogMonitor(14),
                         AnalogMonitor(0) };

#endif
#ifndef INTERPRETER_H
#define INTERPRETER_H

#ifndef WAVETABLES_H
#define WAVETABLES_H

#include <avr/pgmspace.h>



#define WT_BITS 12
#define WT_SIZE 4096


#define WT_INTERP (16 - WT_BITS)
#define WT_MASK   (WT_SIZE - 1)

uint16_t const sine_table[] PROGMEM = {
32768,32818,32868,32918,32969,33019,33069,33119,33170,33220,33270,33320,33371,33421,33471,33521,33572,33622,33672,33722,33773,33823,33873,33923,33974,34024,34074,34124,34174,34225,34275,34325,34375,34426,34476,34526,34576,34626,34676,34727,34777,34827,34877,34927,34977,35028,35078,35128,35178,35228,35278,35328,35378,35429,35479,35529,35579,35629,35679,35729,35779,35829,35879,35929,35979,36029,36079,36129,36179,36229,36279,36329,36379,36429,36479,36529,36579,36629,36679,36729,36779,36828,36878,36928,36978,37028,37078,37127,37177,37227,37277,37327,37376,37426,37476,37526,37575,37625,37675,37725,37774,37824,37874,37923,37973,38022,38072,38122,38171,38221,38270,38320,38369,38419,38468,38518,38567,38617,38666,38716,38765,38815,38864,38913,38963,39012,39061,39111,39160,39209,39259,39308,39357,39406,39456,39505,39554,39603,39652,39701,39750,39800,39849,39898,39947,39996,40045,40094,40143,40192,40241,40290,40339,40387,40436,40485,40534,40583,40632,40680,40729,40778,40827,40875,40924,40973,41021,41070,41119,41167,41216,41264,41313,41361,41410,41458,41507,41555,41604,41652,41700,41749,41797,41845,41894,41942,41990,42038,42087,42135,42183,42231,42279,42327,42375,42423,42471,42519,42567,42615,42663,42711,42759,42807,42855,42903,42950,42998,43046,43094,43141,43189,43237,43284,43332,43379,43427,43474,43522,43569,43617,43664,43712,43759,43806,43854,43901,43948,43995,44043,44090,44137,44184,44231,44278,44325,44372,44419,44466,44513,44560,44607,44654,44701,44748,44794,44841,44888,44934,44981,45028,45074,45121,45167,45214,45260,45307,45353,45400,45446,45492,45539,45585,45631,45677,45724,45770,45816,45862,45908,45954,46000,46046,46092,46138,46184,46230,46275,46321,46367,46413,46458,46504,46550,46595,46641,46686,46732,46777,46823,46868,46913,46959,47004,47049,47094,47140,47185,47230,47275,47320,47365,47410,47455,47500,47545,47590,47634,47679,47724,47769,47813,47858,47903,47947,47992,48036,48081,48125,48169,48214,48258,48302,48347,48391,48435,48479,48523,48567,48611,48655,48699,48743,48787,48831,48875,48918,48962,49006,49049,49093,49136,49180,49223,49267,49310,49354,49397,49440,49484,49527,49570,49613,49656,49699,49742,49785,49828,49871,49914,49957,50000,50042,50085,50128,50170,50213,50255,50298,50340,50383,50425,50467,50510,50552,50594,50636,50678,50720,50762,50804,50846,50888,50930,50972,51014,51055,51097,51139,51180,51222,51263,51305,51346,51388,51429,51470,51512,51553,51594,51635,51676,51717,51758,51799,51840,51881,51922,51962,52003,52044,52084,52125,52165,52206,52246,52287,52327,52367,52408,52448,52488,52528,52568,52608,52648,52688,52728,52768,52808,52847,52887,52927,52966,53006,53045,53085,53124,53164,53203,53242,53281,53321,53360,53399,53438,53477,53516,53555,53593,53632,53671,53710,53748,53787,53825,53864,53902,53941,53979,54017,54056,54094,54132,54170,54208,54246,54284,54322,54360,54397,54435,54473,54511,54548,54586,54623,54661,54698,54735,54772,54810,54847,54884,54921,54958,54995,55032,55069,55106,55142,55179,55216,55252,55289,55325,55362,55398,55434,55471,55507,55543,55579,55615,55651,55687,55723,55759,55795,55830,55866,55902,55937,55973,56008,56044,56079,56114,56150,56185,56220,56255,56290,56325,56360,56395,56429,56464,56499,56534,56568,56603,56637,56671,56706,56740,56774,56809,56843,56877,56911,56945,56979,57012,57046,57080,57114,57147,57181,57214,57248,57281,57314,57348,57381,57414,57447,57480,57513,57546,57579,57612,57645,57677,57710,57742,57775,57807,57840,57872,57904,57937,57969,58001,58033,58065,58097,58129,58160,58192,58224,58255,58287,58318,58350,58381,58413,58444,58475,58506,58537,58568,58599,58630,58661,58692,58722,58753,58784,58814,58845,58875,58905,58936,58966,58996,59026,59056,59086,59116,59146,59176,59205,59235,59265,59294,59324,59353,59383,59412,59441,59470,59499,59528,59557,59586,59615,59644,59673,59701,59730,59758,59787,59815,59844,59872,59900,59928,59956,59984,60012,60040,60068,60096,60123,60151,60179,60206,60234,60261,60288,60316,60343,60370,60397,60424,60451,60478,60504,60531,60558,60584,60611,60637,60664,60690,60716,60743,60769,60795,60821,60847,60873,60899,60924,60950,60976,61001,61027,61052,61077,61103,61128,61153,61178,61203,61228,61253,61278,61302,61327,61352,61376,61401,61425,61449,61474,61498,61522,61546,61570,61594,61618,61642,61665,61689,61713,61736,61760,61783,61806,61830,61853,61876,61899,61922,61945,61968,61990,62013,62036,62058,62081,62103,62126,62148,62170,62192,62214,62236,62258,62280,62302,62324,62345,62367,62389,62410,62431,62453,62474,62495,62516,62537,62558,62579,62600,62621,62641,62662,62683,62703,62723,62744,62764,62784,62804,62824,62844,62864,62884,62904,62924,62943,62963,62982,63002,63021,63040,63059,63079,63098,63117,63136,63154,63173,63192,63210,63229,63248,63266,63284,63303,63321,63339,63357,63375,63393,63411,63428,63446,63464,63481,63499,63516,63534,63551,63568,63585,63602,63619,63636,63653,63670,63686,63703,63719,63736,63752,63769,63785,63801,63817,63833,63849,63865,63881,63896,63912,63928,63943,63959,63974,63989,64004,64020,64035,64050,64065,64079,64094,64109,64124,64138,64153,64167,64181,64196,64210,64224,64238,64252,64266,64280,64293,64307,64321,64334,64348,64361,64374,64387,64401,64414,64427,64440,64452,64465,64478,64491,64503,64516,64528,64540,64553,64565,64577,64589,64601,64613,64624,64636,64648,64659,64671,64682,64694,64705,64716,64727,64738,64749,64760,64771,64782,64792,64803,64814,64824,64834,64845,64855,64865,64875,64885,64895,64905,64915,64924,64934,64944,64953,64962,64972,64981,64990,64999,65008,65017,65026,65035,65043,65052,65061,65069,65078,65086,65094,65102,65110,65118,65126,65134,65142,65150,65157,65165,65172,65180,65187,65194,65202,65209,65216,65223,65230,65236,65243,65250,65256,65263,65269,65276,65282,65288,65294,65300,65306,65312,65318,65324,65329,65335,65340,65346,65351,65356,65362,65367,65372,65377,65382,65386,65391,65396,65400,65405,65409,65414,65418,65422,65426,65430,65434,65438,65442,65446,65449,65453,65456,65460,65463,65467,65470,65473,65476,65479,65482,65485,65487,65490,65493,65495,65497,65500,65502,65504,65506,65508,65510,65512,65514,65516,65518,65519,65521,65522,65523,65525,65526,65527,65528,65529,65530,65531,65531,65532,65533,65533,65534,65534,65534,65534,65534,65535,65534,65534,65534,65534,65534,65533,65533,65532,65531,65531,65530,65529,65528,65527,65526,65525,65523,65522,65521,65519,65518,65516,65514,65512,65510,65508,65506,65504,65502,65500,65497,65495,65493,65490,65487,65485,65482,65479,65476,65473,65470,65467,65463,65460,65456,65453,65449,65446,65442,65438,65434,65430,65426,65422,65418,65414,65409,65405,65400,65396,65391,65386,65382,65377,65372,65367,65362,65356,65351,65346,65340,65335,65329,65324,65318,65312,65306,65300,65294,65288,65282,65276,65269,65263,65256,65250,65243,65236,65230,65223,65216,65209,65202,65194,65187,65180,65172,65165,65157,65150,65142,65134,65126,65118,65110,65102,65094,65086,65078,65069,65061,65052,65043,65035,65026,65017,65008,64999,64990,64981,64972,64962,64953,64944,64934,64924,64915,64905,64895,64885,64875,64865,64855,64845,64834,64824,64814,64803,64792,64782,64771,64760,64749,64738,64727,64716,64705,64694,64682,64671,64659,64648,64636,64624,64613,64601,64589,64577,64565,64553,64540,64528,64516,64503,64491,64478,64465,64452,64440,64427,64414,64401,64387,64374,64361,64348,64334,64321,64307,64293,64280,64266,64252,64238,64224,64210,64196,64181,64167,64153,64138,64124,64109,64094,64079,64065,64050,64035,64020,64004,63989,63974,63959,63943,63928,63912,63896,63881,63865,63849,63833,63817,63801,63785,63769,63752,63736,63719,63703,63686,63670,63653,63636,63619,63602,63585,63568,63551,63534,63516,63499,63481,63464,63446,63428,63411,63393,63375,63357,63339,63321,63303,63284,63266,63248,63229,63210,63192,63173,63154,63136,63117,63098,63079,63059,63040,63021,63002,62982,62963,62943,62924,62904,62884,62864,62844,62824,62804,62784,62764,62744,62723,62703,62683,62662,62641,62621,62600,62579,62558,62537,62516,62495,62474,62453,62431,62410,62389,62367,62345,62324,62302,62280,62258,62236,62214,62192,62170,62148,62126,62103,62081,62058,62036,62013,61990,61968,61945,61922,61899,61876,61853,61830,61806,61783,61760,61736,61713,61689,61665,61642,61618,61594,61570,61546,61522,61498,61474,61449,61425,61401,61376,61352,61327,61302,61278,61253,61228,61203,61178,61153,61128,61103,61077,61052,61027,61001,60976,60950,60924,60899,60873,60847,60821,60795,60769,60743,60716,60690,60664,60637,60611,60584,60558,60531,60504,60478,60451,60424,60397,60370,60343,60316,60288,60261,60234,60206,60179,60151,60123,60096,60068,60040,60012,59984,59956,59928,59900,59872,59844,59815,59787,59758,59730,59701,59673,59644,59615,59586,59557,59528,59499,59470,59441,59412,59383,59353,59324,59294,59265,59235,59205,59176,59146,59116,59086,59056,59026,58996,58966,58936,58905,58875,58845,58814,58784,58753,58722,58692,58661,58630,58599,58568,58537,58506,58475,58444,58413,58381,58350,58318,58287,58255,58224,58192,58160,58129,58097,58065,58033,58001,57969,57937,57904,57872,57840,57807,57775,57742,57710,57677,57645,57612,57579,57546,57513,57480,57447,57414,57381,57348,57314,57281,57248,57214,57181,57147,57114,57080,57046,57012,56979,56945,56911,56877,56843,56809,56774,56740,56706,56671,56637,56603,56568,56534,56499,56464,56429,56395,56360,56325,56290,56255,56220,56185,56150,56114,56079,56044,56008,55973,55937,55902,55866,55830,55795,55759,55723,55687,55651,55615,55579,55543,55507,55471,55434,55398,55362,55325,55289,55252,55216,55179,55142,55106,55069,55032,54995,54958,54921,54884,54847,54810,54772,54735,54698,54661,54623,54586,54548,54511,54473,54435,54397,54360,54322,54284,54246,54208,54170,54132,54094,54056,54017,53979,53941,53902,53864,53825,53787,53748,53710,53671,53632,53593,53555,53516,53477,53438,53399,53360,53321,53281,53242,53203,53164,53124,53085,53045,53006,52966,52927,52887,52847,52808,52768,52728,52688,52648,52608,52568,52528,52488,52448,52408,52367,52327,52287,52246,52206,52165,52125,52084,52044,52003,51962,51922,51881,51840,51799,51758,51717,51676,51635,51594,51553,51512,51470,51429,51388,51346,51305,51263,51222,51180,51139,51097,51055,51014,50972,50930,50888,50846,50804,50762,50720,50678,50636,50594,50552,50510,50467,50425,50383,50340,50298,50255,50213,50170,50128,50085,50042,50000,49957,49914,49871,49828,49785,49742,49699,49656,49613,49570,49527,49484,49440,49397,49354,49310,49267,49223,49180,49136,49093,49049,49006,48962,48918,48875,48831,48787,48743,48699,48655,48611,48567,48523,48479,48435,48391,48347,48302,48258,48214,48169,48125,48081,48036,47992,47947,47903,47858,47813,47769,47724,47679,47634,47590,47545,47500,47455,47410,47365,47320,47275,47230,47185,47140,47094,47049,47004,46959,46913,46868,46823,46777,46732,46686,46641,46595,46550,46504,46458,46413,46367,46321,46275,46230,46184,46138,46092,46046,46000,45954,45908,45862,45816,45770,45724,45677,45631,45585,45539,45492,45446,45400,45353,45307,45260,45214,45167,45121,45074,45028,44981,44934,44888,44841,44794,44748,44701,44654,44607,44560,44513,44466,44419,44372,44325,44278,44231,44184,44137,44090,44043,43995,43948,43901,43854,43806,43759,43712,43664,43617,43569,43522,43474,43427,43379,43332,43284,43237,43189,43141,43094,43046,42998,42950,42903,42855,42807,42759,42711,42663,42615,42567,42519,42471,42423,42375,42327,42279,42231,42183,42135,42087,42038,41990,41942,41894,41845,41797,41749,41700,41652,41604,41555,41507,41458,41410,41361,41313,41264,41216,41167,41119,41070,41021,40973,40924,40875,40827,40778,40729,40680,40632,40583,40534,40485,40436,40387,40339,40290,40241,40192,40143,40094,40045,39996,39947,39898,39849,39800,39750,39701,39652,39603,39554,39505,39456,39406,39357,39308,39259,39209,39160,39111,39061,39012,38963,38913,38864,38815,38765,38716,38666,38617,38567,38518,38468,38419,38369,38320,38270,38221,38171,38122,38072,38022,37973,37923,37874,37824,37774,37725,37675,37625,37575,37526,37476,37426,37376,37327,37277,37227,37177,37127,37078,37028,36978,36928,36878,36828,36779,36729,36679,36629,36579,36529,36479,36429,36379,36329,36279,36229,36179,36129,36079,36029,35979,35929,35879,35829,35779,35729,35679,35629,35579,35529,35479,35429,35378,35328,35278,35228,35178,35128,35078,35028,34977,34927,34877,34827,34777,34727,34676,34626,34576,34526,34476,34426,34375,34325,34275,34225,34174,34124,34074,34024,33974,33923,33873,33823,33773,33722,33672,33622,33572,33521,33471,33421,33371,33320,33270,33220,33170,33119,33069,33019,32969,32918,32868,32818,32768,32717,32667,32617,32566,32516,32466,32416,32365,32315,32265,32215,32164,32114,32064,32014,31963,31913,31863,31813,31762,31712,31662,31612,31561,31511,31461,31411,31361,31310,31260,31210,31160,31109,31059,31009,30959,30909,30859,30808,30758,30708,30658,30608,30558,30507,30457,30407,30357,30307,30257,30207,30157,30106,30056,30006,29956,29906,29856,29806,29756,29706,29656,29606,29556,29506,29456,29406,29356,29306,29256,29206,29156,29106,29056,29006,28956,28906,28856,28806,28756,28707,28657,28607,28557,28507,28457,28408,28358,28308,28258,28208,28159,28109,28059,28009,27960,27910,27860,27810,27761,27711,27661,27612,27562,27513,27463,27413,27364,27314,27265,27215,27166,27116,27067,27017,26968,26918,26869,26819,26770,26720,26671,26622,26572,26523,26474,26424,26375,26326,26276,26227,26178,26129,26079,26030,25981,25932,25883,25834,25785,25735,25686,25637,25588,25539,25490,25441,25392,25343,25294,25245,25196,25148,25099,25050,25001,24952,24903,24855,24806,24757,24708,24660,24611,24562,24514,24465,24416,24368,24319,24271,24222,24174,24125,24077,24028,23980,23931,23883,23835,23786,23738,23690,23641,23593,23545,23497,23448,23400,23352,23304,23256,23208,23160,23112,23064,23016,22968,22920,22872,22824,22776,22728,22680,22632,22585,22537,22489,22441,22394,22346,22298,22251,22203,22156,22108,22061,22013,21966,21918,21871,21823,21776,21729,21681,21634,21587,21540,21492,21445,21398,21351,21304,21257,21210,21163,21116,21069,21022,20975,20928,20881,20834,20787,20741,20694,20647,20601,20554,20507,20461,20414,20368,20321,20275,20228,20182,20135,20089,20043,19996,19950,19904,19858,19811,19765,19719,19673,19627,19581,19535,19489,19443,19397,19351,19305,19260,19214,19168,19122,19077,19031,18985,18940,18894,18849,18803,18758,18712,18667,18622,18576,18531,18486,18441,18395,18350,18305,18260,18215,18170,18125,18080,18035,17990,17945,17901,17856,17811,17766,17722,17677,17632,17588,17543,17499,17454,17410,17366,17321,17277,17233,17188,17144,17100,17056,17012,16968,16924,16880,16836,16792,16748,16704,16660,16617,16573,16529,16486,16442,16399,16355,16312,16268,16225,16181,16138,16095,16051,16008,15965,15922,15879,15836,15793,15750,15707,15664,15621,15578,15535,15493,15450,15407,15365,15322,15280,15237,15195,15152,15110,15068,15025,14983,14941,14899,14857,14815,14773,14731,14689,14647,14605,14563,14521,14480,14438,14396,14355,14313,14272,14230,14189,14147,14106,14065,14023,13982,13941,13900,13859,13818,13777,13736,13695,13654,13613,13573,13532,13491,13451,13410,13370,13329,13289,13248,13208,13168,13127,13087,13047,13007,12967,12927,12887,12847,12807,12767,12727,12688,12648,12608,12569,12529,12490,12450,12411,12371,12332,12293,12254,12214,12175,12136,12097,12058,12019,11980,11942,11903,11864,11825,11787,11748,11710,11671,11633,11594,11556,11518,11479,11441,11403,11365,11327,11289,11251,11213,11175,11138,11100,11062,11024,10987,10949,10912,10874,10837,10800,10763,10725,10688,10651,10614,10577,10540,10503,10466,10429,10393,10356,10319,10283,10246,10210,10173,10137,10101,10064,10028,9992,9956,9920,9884,9848,9812,9776,9740,9705,9669,9633,9598,9562,9527,9491,9456,9421,9385,9350,9315,9280,9245,9210,9175,9140,9106,9071,9036,9001,8967,8932,8898,8864,8829,8795,8761,8726,8692,8658,8624,8590,8556,8523,8489,8455,8421,8388,8354,8321,8287,8254,8221,8187,8154,8121,8088,8055,8022,7989,7956,7923,7890,7858,7825,7793,7760,7728,7695,7663,7631,7598,7566,7534,7502,7470,7438,7406,7375,7343,7311,7280,7248,7217,7185,7154,7122,7091,7060,7029,6998,6967,6936,6905,6874,6843,6813,6782,6751,6721,6690,6660,6630,6599,6569,6539,6509,6479,6449,6419,6389,6359,6330,6300,6270,6241,6211,6182,6152,6123,6094,6065,6036,6007,5978,5949,5920,5891,5862,5834,5805,5777,5748,5720,5691,5663,5635,5607,5579,5551,5523,5495,5467,5439,5412,5384,5356,5329,5301,5274,5247,5219,5192,5165,5138,5111,5084,5057,5031,5004,4977,4951,4924,4898,4871,4845,4819,4792,4766,4740,4714,4688,4662,4636,4611,4585,4559,4534,4508,4483,4458,4432,4407,4382,4357,4332,4307,4282,4257,4233,4208,4183,4159,4134,4110,4086,4061,4037,4013,3989,3965,3941,3917,3893,3870,3846,3822,3799,3775,3752,3729,3705,3682,3659,3636,3613,3590,3567,3545,3522,3499,3477,3454,3432,3409,3387,3365,3343,3321,3299,3277,3255,3233,3211,3190,3168,3146,3125,3104,3082,3061,3040,3019,2998,2977,2956,2935,2914,2894,2873,2852,2832,2812,2791,2771,2751,2731,2711,2691,2671,2651,2631,2611,2592,2572,2553,2533,2514,2495,2476,2456,2437,2418,2399,2381,2362,2343,2325,2306,2287,2269,2251,2232,2214,2196,2178,2160,2142,2124,2107,2089,2071,2054,2036,2019,2001,1984,1967,1950,1933,1916,1899,1882,1865,1849,1832,1816,1799,1783,1766,1750,1734,1718,1702,1686,1670,1654,1639,1623,1607,1592,1576,1561,1546,1531,1515,1500,1485,1470,1456,1441,1426,1411,1397,1382,1368,1354,1339,1325,1311,1297,1283,1269,1255,1242,1228,1214,1201,1187,1174,1161,1148,1134,1121,1108,1095,1083,1070,1057,1044,1032,1019,1007,995,982,970,958,946,934,922,911,899,887,876,864,853,841,830,819,808,797,786,775,764,753,743,732,721,711,701,690,680,670,660,650,640,630,620,611,601,591,582,573,563,554,545,536,527,518,509,500,492,483,474,466,457,449,441,433,425,417,409,401,393,385,378,370,363,355,348,341,333,326,319,312,305,299,292,285,279,272,266,259,253,247,241,235,229,223,217,211,206,200,195,189,184,179,173,168,163,158,153,149,144,139,135,130,126,121,117,113,109,105,101,97,93,89,86,82,79,75,72,68,65,62,59,56,53,50,48,45,42,40,38,35,33,31,29,27,25,23,21,19,17,16,14,13,12,10,9,8,7,6,5,4,4,3,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,3,4,4,5,6,7,8,9,10,12,13,14,16,17,19,21,23,25,27,29,31,33,35,38,40,42,45,48,50,53,56,59,62,65,68,72,75,79,82,86,89,93,97,101,105,109,113,117,121,126,130,135,139,144,149,153,158,163,168,173,179,184,189,195,200,206,211,217,223,229,235,241,247,253,259,266,272,279,285,292,299,305,312,319,326,333,341,348,355,363,370,378,385,393,401,409,417,425,433,441,449,457,466,474,483,492,500,509,518,527,536,545,554,563,573,582,591,601,611,620,630,640,650,660,670,680,690,701,711,721,732,743,753,764,775,786,797,808,819,830,841,853,864,876,887,899,911,922,934,946,958,970,982,995,1007,1019,1032,1044,1057,1070,1083,1095,1108,1121,1134,1148,1161,1174,1187,1201,1214,1228,1242,1255,1269,1283,1297,1311,1325,1339,1354,1368,1382,1397,1411,1426,1441,1456,1470,1485,1500,1515,1531,1546,1561,1576,1592,1607,1623,1639,1654,1670,1686,1702,1718,1734,1750,1766,1783,1799,1816,1832,1849,1865,1882,1899,1916,1933,1950,1967,1984,2001,2019,2036,2054,2071,2089,2107,2124,2142,2160,2178,2196,2214,2232,2251,2269,2287,2306,2325,2343,2362,2381,2399,2418,2437,2456,2476,2495,2514,2533,2553,2572,2592,2611,2631,2651,2671,2691,2711,2731,2751,2771,2791,2812,2832,2852,2873,2894,2914,2935,2956,2977,2998,3019,3040,3061,3082,3104,3125,3146,3168,3190,3211,3233,3255,3277,3299,3321,3343,3365,3387,3409,3432,3454,3477,3499,3522,3545,3567,3590,3613,3636,3659,3682,3705,3729,3752,3775,3799,3822,3846,3870,3893,3917,3941,3965,3989,4013,4037,4061,4086,4110,4134,4159,4183,4208,4233,4257,4282,4307,4332,4357,4382,4407,4432,4458,4483,4508,4534,4559,4585,4611,4636,4662,4688,4714,4740,4766,4792,4819,4845,4871,4898,4924,4951,4977,5004,5031,5057,5084,5111,5138,5165,5192,5219,5247,5274,5301,5329,5356,5384,5412,5439,5467,5495,5523,5551,5579,5607,5635,5663,5691,5720,5748,5777,5805,5834,5862,5891,5920,5949,5978,6007,6036,6065,6094,6123,6152,6182,6211,6241,6270,6300,6330,6359,6389,6419,6449,6479,6509,6539,6569,6599,6630,6660,6690,6721,6751,6782,6813,6843,6874,6905,6936,6967,6998,7029,7060,7091,7122,7154,7185,7217,7248,7280,7311,7343,7375,7406,7438,7470,7502,7534,7566,7598,7631,7663,7695,7728,7760,7793,7825,7858,7890,7923,7956,7989,8022,8055,8088,8121,8154,8187,8221,8254,8287,8321,8354,8388,8421,8455,8489,8523,8556,8590,8624,8658,8692,8726,8761,8795,8829,8864,8898,8932,8967,9001,9036,9071,9106,9140,9175,9210,9245,9280,9315,9350,9385,9421,9456,9491,9527,9562,9598,9633,9669,9705,9740,9776,9812,9848,9884,9920,9956,9992,10028,10064,10101,10137,10173,10210,10246,10283,10319,10356,10393,10429,10466,10503,10540,10577,10614,10651,10688,10725,10763,10800,10837,10874,10912,10949,10987,11024,11062,11100,11138,11175,11213,11251,11289,11327,11365,11403,11441,11479,11518,11556,11594,11633,11671,11710,11748,11787,11825,11864,11903,11942,11980,12019,12058,12097,12136,12175,12214,12254,12293,12332,12371,12411,12450,12490,12529,12569,12608,12648,12688,12727,12767,12807,12847,12887,12927,12967,13007,13047,13087,13127,13168,13208,13248,13289,13329,13370,13410,13451,13491,13532,13573,13613,13654,13695,13736,13777,13818,13859,13900,13941,13982,14023,14065,14106,14147,14189,14230,14272,14313,14355,14396,14438,14480,14521,14563,14605,14647,14689,14731,14773,14815,14857,14899,14941,14983,15025,15068,15110,15152,15195,15237,15280,15322,15365,15407,15450,15493,15535,15578,15621,15664,15707,15750,15793,15836,15879,15922,15965,16008,16051,16095,16138,16181,16225,16268,16312,16355,16399,16442,16486,16529,16573,16617,16660,16704,16748,16792,16836,16880,16924,16968,17012,17056,17100,17144,17188,17233,17277,17321,17366,17410,17454,17499,17543,17588,17632,17677,17722,17766,17811,17856,17901,17945,17990,18035,18080,18125,18170,18215,18260,18305,18350,18395,18441,18486,18531,18576,18622,18667,18712,18758,18803,18849,18894,18940,18985,19031,19077,19122,19168,19214,19260,19305,19351,19397,19443,19489,19535,19581,19627,19673,19719,19765,19811,19858,19904,19950,19996,20043,20089,20135,20182,20228,20275,20321,20368,20414,20461,20507,20554,20601,20647,20694,20741,20787,20834,20881,20928,20975,21022,21069,21116,21163,21210,21257,21304,21351,21398,21445,21492,21540,21587,21634,21681,21729,21776,21823,21871,21918,21966,22013,22061,22108,22156,22203,22251,22298,22346,22394,22441,22489,22537,22585,22632,22680,22728,22776,22824,22872,22920,22968,23016,23064,23112,23160,23208,23256,23304,23352,23400,23448,23497,23545,23593,23641,23690,23738,23786,23835,23883,23931,23980,24028,24077,24125,24174,24222,24271,24319,24368,24416,24465,24514,24562,24611,24660,24708,24757,24806,24855,24903,24952,25001,25050,25099,25148,25196,25245,25294,25343,25392,25441,25490,25539,25588,25637,25686,25735,25785,25834,25883,25932,25981,26030,26079,26129,26178,26227,26276,26326,26375,26424,26474,26523,26572,26622,26671,26720,26770,26819,26869,26918,26968,27017,27067,27116,27166,27215,27265,27314,27364,27413,27463,27513,27562,27612,27661,27711,27761,27810,27860,27910,27960,28009,28059,28109,28159,28208,28258,28308,28358,28408,28457,28507,28557,28607,28657,28707,28756,28806,28856,28906,28956,29006,29056,29106,29156,29206,29256,29306,29356,29406,29456,29506,29556,29606,29656,29706,29756,29806,29856,29906,29956,30006,30056,30106,30157,30207,30257,30307,30357,30407,30457,30507,30558,30608,30658,30708,30758,30808,30859,30909,30959,31009,31059,31109,31160,31210,31260,31310,31361,31411,31461,31511,31561,31612,31662,31712,31762,31813,31863,31913,31963,32014,32064,32114,32164,32215,32265,32315,32365,32416,32466,32516,32566,32617,32667,32717,
};

uint16_t wt_linear(uint16_t const *const wt, uint16_t const i)
{
  uint16_t const e1 = i >> WT_INTERP;
  uint16_t const e2 = min(WT_MASK, e1 + 1);
  uint16_t const w1 = i & ~(-1 << WT_INTERP);
  uint16_t const w2 = (1 << WT_INTERP) - w1;
  return (uint32_t) pgm_read_word_near(wt + e1) * w1
       + (uint32_t) pgm_read_word_near(wt + e2) * w2 >> WT_INTERP;
}

#define sine(i)   wt_linear(sine_table, (i))
#define cosine(i) wt_linear(sine_table, (i) + 4096)

#endif

#define STACK_SIZE   8
#define PROGRAM_SIZE 32

char const *const commands = " +*/-s=.x>abcdefk0123456789ABCDEF";
uint8_t const command_len  = strlen(commands);

typedef uint32_t stack_value;

struct stack
{
  stack_value values[STACK_SIZE];
  uint8_t     top;

  stack_value peek()                    { return values[top]; }
  stack_value pop()                     { return values[top--]; }
  void        push(stack_value const v) { values[++top] = v; }

  void clear()
  {
    top = 0;
  }

  void init1(stack_value const v)
  {
    clear();
    push(v);
  }
};

struct program
{
  char code[PROGRAM_SIZE];

  void set(char const *const s)
  {
    for (int i = 0; s[i]; ++i) code[i] = strchr(commands, s[i]) - commands;
  }
};

void interpret(struct program const *const p, struct stack *const s)
{
  char c;

  stack_value v1;
  stack_value v2;

  for (int i = 0; i < PROGRAM_SIZE; ++i)
    switch (c = commands[p->code[i]])
    {
      case '0': case '1': case '2': case '3': case '4':
      case '5': case '6': case '7': case '8': case '9':
        s->push(s->pop() << 4 | c - '0');
        break;

      case 'A': case 'B': case 'C': case 'D': case 'E': case 'F':
        s->push(s->pop() << 4 | c - 'A' + 0x0a);
        break;

      case 'a': case 'b': case 'c': case 'd': case 'e': case 'f':
        s->push(pots[commands[c] - 'a'].val());
        break;

      case 'k': s->push(0);                     break;
      case '+': s->push(s->pop() + s->pop());   break;
      case '-': s->push(0xffff - s->pop());     break;
      case '*': s->push(s->pop() * s->pop());   break;
      case '/': s->push(s->pop() >> 10);        break;
      case 's': s->push(sine(s->pop()));        break;
      case '=': s->push(s->peek());             break;
      case '.': s->pop();                       break;
      case '>': s->push(s->pop() > s->pop());   break;
      case 'x':
        v1 = s->pop();
        v2 = s->pop();
        s->push(v1);
        s->push(v2);
        break;

      default: break;
    }
}

#endif
#ifndef WAVETABLES_H
#define WAVETABLES_H

#include <avr/pgmspace.h>



#define WT_BITS 12
#define WT_SIZE 4096


#define WT_INTERP (16 - WT_BITS)
#define WT_MASK   (WT_SIZE - 1)

uint16_t const sine_table[] PROGMEM = {
32768,32818,32868,32918,32969,33019,33069,33119,33170,33220,33270,33320,33371,33421,33471,33521,33572,33622,33672,33722,33773,33823,33873,33923,33974,34024,34074,34124,34174,34225,34275,34325,34375,34426,34476,34526,34576,34626,34676,34727,34777,34827,34877,34927,34977,35028,35078,35128,35178,35228,35278,35328,35378,35429,35479,35529,35579,35629,35679,35729,35779,35829,35879,35929,35979,36029,36079,36129,36179,36229,36279,36329,36379,36429,36479,36529,36579,36629,36679,36729,36779,36828,36878,36928,36978,37028,37078,37127,37177,37227,37277,37327,37376,37426,37476,37526,37575,37625,37675,37725,37774,37824,37874,37923,37973,38022,38072,38122,38171,38221,38270,38320,38369,38419,38468,38518,38567,38617,38666,38716,38765,38815,38864,38913,38963,39012,39061,39111,39160,39209,39259,39308,39357,39406,39456,39505,39554,39603,39652,39701,39750,39800,39849,39898,39947,39996,40045,40094,40143,40192,40241,40290,40339,40387,40436,40485,40534,40583,40632,40680,40729,40778,40827,40875,40924,40973,41021,41070,41119,41167,41216,41264,41313,41361,41410,41458,41507,41555,41604,41652,41700,41749,41797,41845,41894,41942,41990,42038,42087,42135,42183,42231,42279,42327,42375,42423,42471,42519,42567,42615,42663,42711,42759,42807,42855,42903,42950,42998,43046,43094,43141,43189,43237,43284,43332,43379,43427,43474,43522,43569,43617,43664,43712,43759,43806,43854,43901,43948,43995,44043,44090,44137,44184,44231,44278,44325,44372,44419,44466,44513,44560,44607,44654,44701,44748,44794,44841,44888,44934,44981,45028,45074,45121,45167,45214,45260,45307,45353,45400,45446,45492,45539,45585,45631,45677,45724,45770,45816,45862,45908,45954,46000,46046,46092,46138,46184,46230,46275,46321,46367,46413,46458,46504,46550,46595,46641,46686,46732,46777,46823,46868,46913,46959,47004,47049,47094,47140,47185,47230,47275,47320,47365,47410,47455,47500,47545,47590,47634,47679,47724,47769,47813,47858,47903,47947,47992,48036,48081,48125,48169,48214,48258,48302,48347,48391,48435,48479,48523,48567,48611,48655,48699,48743,48787,48831,48875,48918,48962,49006,49049,49093,49136,49180,49223,49267,49310,49354,49397,49440,49484,49527,49570,49613,49656,49699,49742,49785,49828,49871,49914,49957,50000,50042,50085,50128,50170,50213,50255,50298,50340,50383,50425,50467,50510,50552,50594,50636,50678,50720,50762,50804,50846,50888,50930,50972,51014,51055,51097,51139,51180,51222,51263,51305,51346,51388,51429,51470,51512,51553,51594,51635,51676,51717,51758,51799,51840,51881,51922,51962,52003,52044,52084,52125,52165,52206,52246,52287,52327,52367,52408,52448,52488,52528,52568,52608,52648,52688,52728,52768,52808,52847,52887,52927,52966,53006,53045,53085,53124,53164,53203,53242,53281,53321,53360,53399,53438,53477,53516,53555,53593,53632,53671,53710,53748,53787,53825,53864,53902,53941,53979,54017,54056,54094,54132,54170,54208,54246,54284,54322,54360,54397,54435,54473,54511,54548,54586,54623,54661,54698,54735,54772,54810,54847,54884,54921,54958,54995,55032,55069,55106,55142,55179,55216,55252,55289,55325,55362,55398,55434,55471,55507,55543,55579,55615,55651,55687,55723,55759,55795,55830,55866,55902,55937,55973,56008,56044,56079,56114,56150,56185,56220,56255,56290,56325,56360,56395,56429,56464,56499,56534,56568,56603,56637,56671,56706,56740,56774,56809,56843,56877,56911,56945,56979,57012,57046,57080,57114,57147,57181,57214,57248,57281,57314,57348,57381,57414,57447,57480,57513,57546,57579,57612,57645,57677,57710,57742,57775,57807,57840,57872,57904,57937,57969,58001,58033,58065,58097,58129,58160,58192,58224,58255,58287,58318,58350,58381,58413,58444,58475,58506,58537,58568,58599,58630,58661,58692,58722,58753,58784,58814,58845,58875,58905,58936,58966,58996,59026,59056,59086,59116,59146,59176,59205,59235,59265,59294,59324,59353,59383,59412,59441,59470,59499,59528,59557,59586,59615,59644,59673,59701,59730,59758,59787,59815,59844,59872,59900,59928,59956,59984,60012,60040,60068,60096,60123,60151,60179,60206,60234,60261,60288,60316,60343,60370,60397,60424,60451,60478,60504,60531,60558,60584,60611,60637,60664,60690,60716,60743,60769,60795,60821,60847,60873,60899,60924,60950,60976,61001,61027,61052,61077,61103,61128,61153,61178,61203,61228,61253,61278,61302,61327,61352,61376,61401,61425,61449,61474,61498,61522,61546,61570,61594,61618,61642,61665,61689,61713,61736,61760,61783,61806,61830,61853,61876,61899,61922,61945,61968,61990,62013,62036,62058,62081,62103,62126,62148,62170,62192,62214,62236,62258,62280,62302,62324,62345,62367,62389,62410,62431,62453,62474,62495,62516,62537,62558,62579,62600,62621,62641,62662,62683,62703,62723,62744,62764,62784,62804,62824,62844,62864,62884,62904,62924,62943,62963,62982,63002,63021,63040,63059,63079,63098,63117,63136,63154,63173,63192,63210,63229,63248,63266,63284,63303,63321,63339,63357,63375,63393,63411,63428,63446,63464,63481,63499,63516,63534,63551,63568,63585,63602,63619,63636,63653,63670,63686,63703,63719,63736,63752,63769,63785,63801,63817,63833,63849,63865,63881,63896,63912,63928,63943,63959,63974,63989,64004,64020,64035,64050,64065,64079,64094,64109,64124,64138,64153,64167,64181,64196,64210,64224,64238,64252,64266,64280,64293,64307,64321,64334,64348,64361,64374,64387,64401,64414,64427,64440,64452,64465,64478,64491,64503,64516,64528,64540,64553,64565,64577,64589,64601,64613,64624,64636,64648,64659,64671,64682,64694,64705,64716,64727,64738,64749,64760,64771,64782,64792,64803,64814,64824,64834,64845,64855,64865,64875,64885,64895,64905,64915,64924,64934,64944,64953,64962,64972,64981,64990,64999,65008,65017,65026,65035,65043,65052,65061,65069,65078,65086,65094,65102,65110,65118,65126,65134,65142,65150,65157,65165,65172,65180,65187,65194,65202,65209,65216,65223,65230,65236,65243,65250,65256,65263,65269,65276,65282,65288,65294,65300,65306,65312,65318,65324,65329,65335,65340,65346,65351,65356,65362,65367,65372,65377,65382,65386,65391,65396,65400,65405,65409,65414,65418,65422,65426,65430,65434,65438,65442,65446,65449,65453,65456,65460,65463,65467,65470,65473,65476,65479,65482,65485,65487,65490,65493,65495,65497,65500,65502,65504,65506,65508,65510,65512,65514,65516,65518,65519,65521,65522,65523,65525,65526,65527,65528,65529,65530,65531,65531,65532,65533,65533,65534,65534,65534,65534,65534,65535,65534,65534,65534,65534,65534,65533,65533,65532,65531,65531,65530,65529,65528,65527,65526,65525,65523,65522,65521,65519,65518,65516,65514,65512,65510,65508,65506,65504,65502,65500,65497,65495,65493,65490,65487,65485,65482,65479,65476,65473,65470,65467,65463,65460,65456,65453,65449,65446,65442,65438,65434,65430,65426,65422,65418,65414,65409,65405,65400,65396,65391,65386,65382,65377,65372,65367,65362,65356,65351,65346,65340,65335,65329,65324,65318,65312,65306,65300,65294,65288,65282,65276,65269,65263,65256,65250,65243,65236,65230,65223,65216,65209,65202,65194,65187,65180,65172,65165,65157,65150,65142,65134,65126,65118,65110,65102,65094,65086,65078,65069,65061,65052,65043,65035,65026,65017,65008,64999,64990,64981,64972,64962,64953,64944,64934,64924,64915,64905,64895,64885,64875,64865,64855,64845,64834,64824,64814,64803,64792,64782,64771,64760,64749,64738,64727,64716,64705,64694,64682,64671,64659,64648,64636,64624,64613,64601,64589,64577,64565,64553,64540,64528,64516,64503,64491,64478,64465,64452,64440,64427,64414,64401,64387,64374,64361,64348,64334,64321,64307,64293,64280,64266,64252,64238,64224,64210,64196,64181,64167,64153,64138,64124,64109,64094,64079,64065,64050,64035,64020,64004,63989,63974,63959,63943,63928,63912,63896,63881,63865,63849,63833,63817,63801,63785,63769,63752,63736,63719,63703,63686,63670,63653,63636,63619,63602,63585,63568,63551,63534,63516,63499,63481,63464,63446,63428,63411,63393,63375,63357,63339,63321,63303,63284,63266,63248,63229,63210,63192,63173,63154,63136,63117,63098,63079,63059,63040,63021,63002,62982,62963,62943,62924,62904,62884,62864,62844,62824,62804,62784,62764,62744,62723,62703,62683,62662,62641,62621,62600,62579,62558,62537,62516,62495,62474,62453,62431,62410,62389,62367,62345,62324,62302,62280,62258,62236,62214,62192,62170,62148,62126,62103,62081,62058,62036,62013,61990,61968,61945,61922,61899,61876,61853,61830,61806,61783,61760,61736,61713,61689,61665,61642,61618,61594,61570,61546,61522,61498,61474,61449,61425,61401,61376,61352,61327,61302,61278,61253,61228,61203,61178,61153,61128,61103,61077,61052,61027,61001,60976,60950,60924,60899,60873,60847,60821,60795,60769,60743,60716,60690,60664,60637,60611,60584,60558,60531,60504,60478,60451,60424,60397,60370,60343,60316,60288,60261,60234,60206,60179,60151,60123,60096,60068,60040,60012,59984,59956,59928,59900,59872,59844,59815,59787,59758,59730,59701,59673,59644,59615,59586,59557,59528,59499,59470,59441,59412,59383,59353,59324,59294,59265,59235,59205,59176,59146,59116,59086,59056,59026,58996,58966,58936,58905,58875,58845,58814,58784,58753,58722,58692,58661,58630,58599,58568,58537,58506,58475,58444,58413,58381,58350,58318,58287,58255,58224,58192,58160,58129,58097,58065,58033,58001,57969,57937,57904,57872,57840,57807,57775,57742,57710,57677,57645,57612,57579,57546,57513,57480,57447,57414,57381,57348,57314,57281,57248,57214,57181,57147,57114,57080,57046,57012,56979,56945,56911,56877,56843,56809,56774,56740,56706,56671,56637,56603,56568,56534,56499,56464,56429,56395,56360,56325,56290,56255,56220,56185,56150,56114,56079,56044,56008,55973,55937,55902,55866,55830,55795,55759,55723,55687,55651,55615,55579,55543,55507,55471,55434,55398,55362,55325,55289,55252,55216,55179,55142,55106,55069,55032,54995,54958,54921,54884,54847,54810,54772,54735,54698,54661,54623,54586,54548,54511,54473,54435,54397,54360,54322,54284,54246,54208,54170,54132,54094,54056,54017,53979,53941,53902,53864,53825,53787,53748,53710,53671,53632,53593,53555,53516,53477,53438,53399,53360,53321,53281,53242,53203,53164,53124,53085,53045,53006,52966,52927,52887,52847,52808,52768,52728,52688,52648,52608,52568,52528,52488,52448,52408,52367,52327,52287,52246,52206,52165,52125,52084,52044,52003,51962,51922,51881,51840,51799,51758,51717,51676,51635,51594,51553,51512,51470,51429,51388,51346,51305,51263,51222,51180,51139,51097,51055,51014,50972,50930,50888,50846,50804,50762,50720,50678,50636,50594,50552,50510,50467,50425,50383,50340,50298,50255,50213,50170,50128,50085,50042,50000,49957,49914,49871,49828,49785,49742,49699,49656,49613,49570,49527,49484,49440,49397,49354,49310,49267,49223,49180,49136,49093,49049,49006,48962,48918,48875,48831,48787,48743,48699,48655,48611,48567,48523,48479,48435,48391,48347,48302,48258,48214,48169,48125,48081,48036,47992,47947,47903,47858,47813,47769,47724,47679,47634,47590,47545,47500,47455,47410,47365,47320,47275,47230,47185,47140,47094,47049,47004,46959,46913,46868,46823,46777,46732,46686,46641,46595,46550,46504,46458,46413,46367,46321,46275,46230,46184,46138,46092,46046,46000,45954,45908,45862,45816,45770,45724,45677,45631,45585,45539,45492,45446,45400,45353,45307,45260,45214,45167,45121,45074,45028,44981,44934,44888,44841,44794,44748,44701,44654,44607,44560,44513,44466,44419,44372,44325,44278,44231,44184,44137,44090,44043,43995,43948,43901,43854,43806,43759,43712,43664,43617,43569,43522,43474,43427,43379,43332,43284,43237,43189,43141,43094,43046,42998,42950,42903,42855,42807,42759,42711,42663,42615,42567,42519,42471,42423,42375,42327,42279,42231,42183,42135,42087,42038,41990,41942,41894,41845,41797,41749,41700,41652,41604,41555,41507,41458,41410,41361,41313,41264,41216,41167,41119,41070,41021,40973,40924,40875,40827,40778,40729,40680,40632,40583,40534,40485,40436,40387,40339,40290,40241,40192,40143,40094,40045,39996,39947,39898,39849,39800,39750,39701,39652,39603,39554,39505,39456,39406,39357,39308,39259,39209,39160,39111,39061,39012,38963,38913,38864,38815,38765,38716,38666,38617,38567,38518,38468,38419,38369,38320,38270,38221,38171,38122,38072,38022,37973,37923,37874,37824,37774,37725,37675,37625,37575,37526,37476,37426,37376,37327,37277,37227,37177,37127,37078,37028,36978,36928,36878,36828,36779,36729,36679,36629,36579,36529,36479,36429,36379,36329,36279,36229,36179,36129,36079,36029,35979,35929,35879,35829,35779,35729,35679,35629,35579,35529,35479,35429,35378,35328,35278,35228,35178,35128,35078,35028,34977,34927,34877,34827,34777,34727,34676,34626,34576,34526,34476,34426,34375,34325,34275,34225,34174,34124,34074,34024,33974,33923,33873,33823,33773,33722,33672,33622,33572,33521,33471,33421,33371,33320,33270,33220,33170,33119,33069,33019,32969,32918,32868,32818,32768,32717,32667,32617,32566,32516,32466,32416,32365,32315,32265,32215,32164,32114,32064,32014,31963,31913,31863,31813,31762,31712,31662,31612,31561,31511,31461,31411,31361,31310,31260,31210,31160,31109,31059,31009,30959,30909,30859,30808,30758,30708,30658,30608,30558,30507,30457,30407,30357,30307,30257,30207,30157,30106,30056,30006,29956,29906,29856,29806,29756,29706,29656,29606,29556,29506,29456,29406,29356,29306,29256,29206,29156,29106,29056,29006,28956,28906,28856,28806,28756,28707,28657,28607,28557,28507,28457,28408,28358,28308,28258,28208,28159,28109,28059,28009,27960,27910,27860,27810,27761,27711,27661,27612,27562,27513,27463,27413,27364,27314,27265,27215,27166,27116,27067,27017,26968,26918,26869,26819,26770,26720,26671,26622,26572,26523,26474,26424,26375,26326,26276,26227,26178,26129,26079,26030,25981,25932,25883,25834,25785,25735,25686,25637,25588,25539,25490,25441,25392,25343,25294,25245,25196,25148,25099,25050,25001,24952,24903,24855,24806,24757,24708,24660,24611,24562,24514,24465,24416,24368,24319,24271,24222,24174,24125,24077,24028,23980,23931,23883,23835,23786,23738,23690,23641,23593,23545,23497,23448,23400,23352,23304,23256,23208,23160,23112,23064,23016,22968,22920,22872,22824,22776,22728,22680,22632,22585,22537,22489,22441,22394,22346,22298,22251,22203,22156,22108,22061,22013,21966,21918,21871,21823,21776,21729,21681,21634,21587,21540,21492,21445,21398,21351,21304,21257,21210,21163,21116,21069,21022,20975,20928,20881,20834,20787,20741,20694,20647,20601,20554,20507,20461,20414,20368,20321,20275,20228,20182,20135,20089,20043,19996,19950,19904,19858,19811,19765,19719,19673,19627,19581,19535,19489,19443,19397,19351,19305,19260,19214,19168,19122,19077,19031,18985,18940,18894,18849,18803,18758,18712,18667,18622,18576,18531,18486,18441,18395,18350,18305,18260,18215,18170,18125,18080,18035,17990,17945,17901,17856,17811,17766,17722,17677,17632,17588,17543,17499,17454,17410,17366,17321,17277,17233,17188,17144,17100,17056,17012,16968,16924,16880,16836,16792,16748,16704,16660,16617,16573,16529,16486,16442,16399,16355,16312,16268,16225,16181,16138,16095,16051,16008,15965,15922,15879,15836,15793,15750,15707,15664,15621,15578,15535,15493,15450,15407,15365,15322,15280,15237,15195,15152,15110,15068,15025,14983,14941,14899,14857,14815,14773,14731,14689,14647,14605,14563,14521,14480,14438,14396,14355,14313,14272,14230,14189,14147,14106,14065,14023,13982,13941,13900,13859,13818,13777,13736,13695,13654,13613,13573,13532,13491,13451,13410,13370,13329,13289,13248,13208,13168,13127,13087,13047,13007,12967,12927,12887,12847,12807,12767,12727,12688,12648,12608,12569,12529,12490,12450,12411,12371,12332,12293,12254,12214,12175,12136,12097,12058,12019,11980,11942,11903,11864,11825,11787,11748,11710,11671,11633,11594,11556,11518,11479,11441,11403,11365,11327,11289,11251,11213,11175,11138,11100,11062,11024,10987,10949,10912,10874,10837,10800,10763,10725,10688,10651,10614,10577,10540,10503,10466,10429,10393,10356,10319,10283,10246,10210,10173,10137,10101,10064,10028,9992,9956,9920,9884,9848,9812,9776,9740,9705,9669,9633,9598,9562,9527,9491,9456,9421,9385,9350,9315,9280,9245,9210,9175,9140,9106,9071,9036,9001,8967,8932,8898,8864,8829,8795,8761,8726,8692,8658,8624,8590,8556,8523,8489,8455,8421,8388,8354,8321,8287,8254,8221,8187,8154,8121,8088,8055,8022,7989,7956,7923,7890,7858,7825,7793,7760,7728,7695,7663,7631,7598,7566,7534,7502,7470,7438,7406,7375,7343,7311,7280,7248,7217,7185,7154,7122,7091,7060,7029,6998,6967,6936,6905,6874,6843,6813,6782,6751,6721,6690,6660,6630,6599,6569,6539,6509,6479,6449,6419,6389,6359,6330,6300,6270,6241,6211,6182,6152,6123,6094,6065,6036,6007,5978,5949,5920,5891,5862,5834,5805,5777,5748,5720,5691,5663,5635,5607,5579,5551,5523,5495,5467,5439,5412,5384,5356,5329,5301,5274,5247,5219,5192,5165,5138,5111,5084,5057,5031,5004,4977,4951,4924,4898,4871,4845,4819,4792,4766,4740,4714,4688,4662,4636,4611,4585,4559,4534,4508,4483,4458,4432,4407,4382,4357,4332,4307,4282,4257,4233,4208,4183,4159,4134,4110,4086,4061,4037,4013,3989,3965,3941,3917,3893,3870,3846,3822,3799,3775,3752,3729,3705,3682,3659,3636,3613,3590,3567,3545,3522,3499,3477,3454,3432,3409,3387,3365,3343,3321,3299,3277,3255,3233,3211,3190,3168,3146,3125,3104,3082,3061,3040,3019,2998,2977,2956,2935,2914,2894,2873,2852,2832,2812,2791,2771,2751,2731,2711,2691,2671,2651,2631,2611,2592,2572,2553,2533,2514,2495,2476,2456,2437,2418,2399,2381,2362,2343,2325,2306,2287,2269,2251,2232,2214,2196,2178,2160,2142,2124,2107,2089,2071,2054,2036,2019,2001,1984,1967,1950,1933,1916,1899,1882,1865,1849,1832,1816,1799,1783,1766,1750,1734,1718,1702,1686,1670,1654,1639,1623,1607,1592,1576,1561,1546,1531,1515,1500,1485,1470,1456,1441,1426,1411,1397,1382,1368,1354,1339,1325,1311,1297,1283,1269,1255,1242,1228,1214,1201,1187,1174,1161,1148,1134,1121,1108,1095,1083,1070,1057,1044,1032,1019,1007,995,982,970,958,946,934,922,911,899,887,876,864,853,841,830,819,808,797,786,775,764,753,743,732,721,711,701,690,680,670,660,650,640,630,620,611,601,591,582,573,563,554,545,536,527,518,509,500,492,483,474,466,457,449,441,433,425,417,409,401,393,385,378,370,363,355,348,341,333,326,319,312,305,299,292,285,279,272,266,259,253,247,241,235,229,223,217,211,206,200,195,189,184,179,173,168,163,158,153,149,144,139,135,130,126,121,117,113,109,105,101,97,93,89,86,82,79,75,72,68,65,62,59,56,53,50,48,45,42,40,38,35,33,31,29,27,25,23,21,19,17,16,14,13,12,10,9,8,7,6,5,4,4,3,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,3,4,4,5,6,7,8,9,10,12,13,14,16,17,19,21,23,25,27,29,31,33,35,38,40,42,45,48,50,53,56,59,62,65,68,72,75,79,82,86,89,93,97,101,105,109,113,117,121,126,130,135,139,144,149,153,158,163,168,173,179,184,189,195,200,206,211,217,223,229,235,241,247,253,259,266,272,279,285,292,299,305,312,319,326,333,341,348,355,363,370,378,385,393,401,409,417,425,433,441,449,457,466,474,483,492,500,509,518,527,536,545,554,563,573,582,591,601,611,620,630,640,650,660,670,680,690,701,711,721,732,743,753,764,775,786,797,808,819,830,841,853,864,876,887,899,911,922,934,946,958,970,982,995,1007,1019,1032,1044,1057,1070,1083,1095,1108,1121,1134,1148,1161,1174,1187,1201,1214,1228,1242,1255,1269,1283,1297,1311,1325,1339,1354,1368,1382,1397,1411,1426,1441,1456,1470,1485,1500,1515,1531,1546,1561,1576,1592,1607,1623,1639,1654,1670,1686,1702,1718,1734,1750,1766,1783,1799,1816,1832,1849,1865,1882,1899,1916,1933,1950,1967,1984,2001,2019,2036,2054,2071,2089,2107,2124,2142,2160,2178,2196,2214,2232,2251,2269,2287,2306,2325,2343,2362,2381,2399,2418,2437,2456,2476,2495,2514,2533,2553,2572,2592,2611,2631,2651,2671,2691,2711,2731,2751,2771,2791,2812,2832,2852,2873,2894,2914,2935,2956,2977,2998,3019,3040,3061,3082,3104,3125,3146,3168,3190,3211,3233,3255,3277,3299,3321,3343,3365,3387,3409,3432,3454,3477,3499,3522,3545,3567,3590,3613,3636,3659,3682,3705,3729,3752,3775,3799,3822,3846,3870,3893,3917,3941,3965,3989,4013,4037,4061,4086,4110,4134,4159,4183,4208,4233,4257,4282,4307,4332,4357,4382,4407,4432,4458,4483,4508,4534,4559,4585,4611,4636,4662,4688,4714,4740,4766,4792,4819,4845,4871,4898,4924,4951,4977,5004,5031,5057,5084,5111,5138,5165,5192,5219,5247,5274,5301,5329,5356,5384,5412,5439,5467,5495,5523,5551,5579,5607,5635,5663,5691,5720,5748,5777,5805,5834,5862,5891,5920,5949,5978,6007,6036,6065,6094,6123,6152,6182,6211,6241,6270,6300,6330,6359,6389,6419,6449,6479,6509,6539,6569,6599,6630,6660,6690,6721,6751,6782,6813,6843,6874,6905,6936,6967,6998,7029,7060,7091,7122,7154,7185,7217,7248,7280,7311,7343,7375,7406,7438,7470,7502,7534,7566,7598,7631,7663,7695,7728,7760,7793,7825,7858,7890,7923,7956,7989,8022,8055,8088,8121,8154,8187,8221,8254,8287,8321,8354,8388,8421,8455,8489,8523,8556,8590,8624,8658,8692,8726,8761,8795,8829,8864,8898,8932,8967,9001,9036,9071,9106,9140,9175,9210,9245,9280,9315,9350,9385,9421,9456,9491,9527,9562,9598,9633,9669,9705,9740,9776,9812,9848,9884,9920,9956,9992,10028,10064,10101,10137,10173,10210,10246,10283,10319,10356,10393,10429,10466,10503,10540,10577,10614,10651,10688,10725,10763,10800,10837,10874,10912,10949,10987,11024,11062,11100,11138,11175,11213,11251,11289,11327,11365,11403,11441,11479,11518,11556,11594,11633,11671,11710,11748,11787,11825,11864,11903,11942,11980,12019,12058,12097,12136,12175,12214,12254,12293,12332,12371,12411,12450,12490,12529,12569,12608,12648,12688,12727,12767,12807,12847,12887,12927,12967,13007,13047,13087,13127,13168,13208,13248,13289,13329,13370,13410,13451,13491,13532,13573,13613,13654,13695,13736,13777,13818,13859,13900,13941,13982,14023,14065,14106,14147,14189,14230,14272,14313,14355,14396,14438,14480,14521,14563,14605,14647,14689,14731,14773,14815,14857,14899,14941,14983,15025,15068,15110,15152,15195,15237,15280,15322,15365,15407,15450,15493,15535,15578,15621,15664,15707,15750,15793,15836,15879,15922,15965,16008,16051,16095,16138,16181,16225,16268,16312,16355,16399,16442,16486,16529,16573,16617,16660,16704,16748,16792,16836,16880,16924,16968,17012,17056,17100,17144,17188,17233,17277,17321,17366,17410,17454,17499,17543,17588,17632,17677,17722,17766,17811,17856,17901,17945,17990,18035,18080,18125,18170,18215,18260,18305,18350,18395,18441,18486,18531,18576,18622,18667,18712,18758,18803,18849,18894,18940,18985,19031,19077,19122,19168,19214,19260,19305,19351,19397,19443,19489,19535,19581,19627,19673,19719,19765,19811,19858,19904,19950,19996,20043,20089,20135,20182,20228,20275,20321,20368,20414,20461,20507,20554,20601,20647,20694,20741,20787,20834,20881,20928,20975,21022,21069,21116,21163,21210,21257,21304,21351,21398,21445,21492,21540,21587,21634,21681,21729,21776,21823,21871,21918,21966,22013,22061,22108,22156,22203,22251,22298,22346,22394,22441,22489,22537,22585,22632,22680,22728,22776,22824,22872,22920,22968,23016,23064,23112,23160,23208,23256,23304,23352,23400,23448,23497,23545,23593,23641,23690,23738,23786,23835,23883,23931,23980,24028,24077,24125,24174,24222,24271,24319,24368,24416,24465,24514,24562,24611,24660,24708,24757,24806,24855,24903,24952,25001,25050,25099,25148,25196,25245,25294,25343,25392,25441,25490,25539,25588,25637,25686,25735,25785,25834,25883,25932,25981,26030,26079,26129,26178,26227,26276,26326,26375,26424,26474,26523,26572,26622,26671,26720,26770,26819,26869,26918,26968,27017,27067,27116,27166,27215,27265,27314,27364,27413,27463,27513,27562,27612,27661,27711,27761,27810,27860,27910,27960,28009,28059,28109,28159,28208,28258,28308,28358,28408,28457,28507,28557,28607,28657,28707,28756,28806,28856,28906,28956,29006,29056,29106,29156,29206,29256,29306,29356,29406,29456,29506,29556,29606,29656,29706,29756,29806,29856,29906,29956,30006,30056,30106,30157,30207,30257,30307,30357,30407,30457,30507,30558,30608,30658,30708,30758,30808,30859,30909,30959,31009,31059,31109,31160,31210,31260,31310,31361,31411,31461,31511,31561,31612,31662,31712,31762,31813,31863,31913,31963,32014,32064,32114,32164,32215,32265,32315,32365,32416,32466,32516,32566,32617,32667,32717,
};

uint16_t wt_linear(uint16_t const *const wt, uint16_t const i)
{
  uint16_t const e1 = i >> WT_INTERP;
  uint16_t const e2 = min(WT_MASK, e1 + 1);
  uint16_t const w1 = i & ~(-1 << WT_INTERP);
  uint16_t const w2 = (1 << WT_INTERP) - w1;
  return (uint32_t) pgm_read_word_near(wt + e1) * w1
       + (uint32_t) pgm_read_word_near(wt + e2) * w2 >> WT_INTERP;
}

#define sine(i)   wt_linear(sine_table, (i))
#define cosine(i) wt_linear(sine_table, (i) + 4096)

#endif
#ifndef LCD_DETECTOR_H
#define LCD_DETECTOR_H

#ifndef ASYNC_ANALOG_H
#define ASYNC_ANALOG_H

uint16_t *async_analog_dest = 0;

#define async_analog_ready() (!async_analog_dest)

#define async_analog_check()                                            \
  do                                                                    \
  {                                                                     \
    if (!bit_is_set(ADCSRA, ADSC) && async_analog_dest)                 \
    {                                                                   \
      uint8_t low, high;                                                \
      low  = ADCL;                                                      \
      high = ADCH;                                                      \
      *async_analog_dest = high << 8 | low;                             \
      async_analog_dest = 0;                                            \
    }                                                                   \
  } while (0)

#define async_analog_read(pin, into)                                    \
  do                                                                    \
  {                                                                     \
    if (async_analog_ready())                                           \
    {                                                                   \
      async_analog_dest = (into);                                       \
      ADMUX   = DEFAULT << 6 | (pin) & 7;                               \
      ADCSRB  = ((pin) >> 3 & 1) << MUX5;                               \
      ADCSRA |= 1 << ADSC;                                              \
    }                                                                   \
  } while (0)

class AnalogMonitor
{
 private:
  uint8_t  pin;
  uint8_t  last_value;
  uint16_t value;

 public:
  AnalogMonitor(uint8_t _pin): pin(_pin), last_value(0), value(0) {}

  bool has_changed()
  {
    async_analog_check();
    bool result = value >> 2 != last_value;
    last_value  = value >> 2;
    return result;
  }

  void update()
  {
    async_analog_check();
    async_analog_read(pin, &value);
  }

  uint16_t val()
  {
    async_analog_check();
    return value;
  }
};

#define LCD_POT 6

AnalogMonitor pots[] = { AnalogMonitor(9),
                         AnalogMonitor(10),
                         AnalogMonitor(11),
                         AnalogMonitor(12),
                         AnalogMonitor(13),
                         AnalogMonitor(14),
                         AnalogMonitor(0) };

#endif

#define LCDNone 0
#define LCDLeft 1
#define LCDRight 2
#define LCDUp 3
#define LCDDown 4
#define LCDSelect 5

class LCDKey
{
 private:
  bool expecting_key = false;

 public:
  int command(int const val)
  {
    int const a = val >> 6;
    if (!expecting_key) {
      if (a == 15) expecting_key = true;
      return LCDNone;
    }

    switch (a) {
    case 4:  expecting_key = false; return LCDDown;
    case 1:  expecting_key = false; return LCDUp;
    case 6:  expecting_key = false; return LCDLeft;
    case 0:  expecting_key = false; return LCDRight;
    case 10: expecting_key = false; return LCDSelect;
    default:
      expecting_key = true;
      return LCDNone;
    }
  }
};

#endif
#ifndef REPEAT_H
#define REPEAT_H

#define repeat_2(x) x x
#define repeat_4(x) repeat_2(repeat_2(x))
#define repeat_8(x) repeat_4(repeat_2(x))
#define repeat_16(x) repeat_4(repeat_4(x))
#define repeat_32(x) repeat_8(repeat_4(x))
#define repeat_64(x) repeat_8(repeat_8(x))

#endif

LiquidCrystal lcd(8, 9, 4, 5, 6, 7);
LCDKey        lcdkey;

program p;
int edit_point = 0;

bool run_mode = false;

void update_display()
{
  lcd.home();
  lcd.clear();

  if (run_mode)
    lcd.print("running");
  else
  {
    for (int i = 0; i < PROGRAM_SIZE; ++i)
      lcd.print(commands[p.code[i]]);
    lcd.setCursor(edit_point & 0x1f, !!(edit_point & 0x20));
    lcd.cursor();
  }
}

#define BUF_SIZE 2048

void setup()
{
  cli();
  DDRL = DDRC = DDRA = 0xff;

  char which_pot = 0;

  for (int i = 0; i < PROGRAM_SIZE; ++i) p.code[i] = 0;
  p.set("s=");

  TCCR3B = 0x0a;
  TCCR3A = 0x00;
  OCR3A  = BUF_SIZE;

  lcd.begin(16, 2);

  uint8_t a_buf[BUF_SIZE];
  uint8_t c_buf[BUF_SIZE];
  uint8_t l_buf[BUF_SIZE];

  while (1)
  {
    if (run_mode)
    {
      pots[LCD_POT].update();
      run_mode &= lcdkey.command(pots[LCD_POT].val()) == LCDNone;

      int t;
      uint8_t a, c, l;
      for (uint8_t i = 1; i; ++i)
      {
        repeat_32(
          t = TCNT3;
          a = a_buf[t];
          c = c_buf[t];
          l = l_buf[t];
          PORTA = a;
          PORTC = c;
          PORTL = l;
        )
      }
    }
    else
    {
      if (++which_pot >= sizeof(pots) / sizeof(AnalogMonitor))
        which_pot = 0;

      pots[which_pot].update();
      if (pots[which_pot].has_changed())
      {
        PORTA = PORTC = PORTL = 0;

        switch (lcdkey.command(pots[LCD_POT].val()))
        {
          case LCDNone:                        break;
          case LCDRight: ++edit_point;         break;
          case LCDLeft:  --edit_point;         break;
          case LCDUp:    ++p.code[edit_point]; break;
          case LCDDown:  --p.code[edit_point]; break;
          case LCDSelect: run_mode = true;     break;
        }

        edit_point &= PROGRAM_SIZE - 1;
        p.code[edit_point] += command_len;
        p.code[edit_point] %= command_len;

        if (run_mode)
        {
          stack s;
          for (int i = 0; i < BUF_SIZE; ++i)
          {
            if (!(i & 0xff))
            {
              lcd.home();
              lcd.clear();
              lcd.print("compiling: ");
              lcd.print(i);
            }

            s.init1(i);
            interpret(&p, &s);
            uint16_t ca = s.pop();
            uint16_t cb = s.pop();
            a_buf[i] = ca & 0xf000 | cb >> 4 & 0xf000;
            c_buf[i] = ca & 0x0f00 | cb >> 4 & 0x0f00;
            l_buf[i] = ca & 0x00f0 | cb >> 4 & 0x00f0;
            OCR3A = i;
          }
        }

        update_display();
      }
    }
  }
}

void loop()
{}
